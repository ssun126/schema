<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://ultraq.net.nz/thymeleaf/layout">
<body>
<div class="cui_content">
    <div class="cui_main">
        <div class="cui_head">
            <div class="head_content">
                <h2 class="cui_title"><span>ISO 인증</span></h2>
            </div>
        </div>
        <div class="cui_body">
            <div class="cui_toolbar">
                <div class="toolbar_content">
                    <div class="toolbar_default"></div>
                </div>
            </div>
            <form class="cui_form_field" data-legend="true">
                <fieldset>
                    <legend><span>인증서 관리(배점 4점)</span></legend>
                    <table class="cui_table" id="isoAuthItemTable">
                        <colgroup>
                            <col style="width:120px;">
                            <col >
                            <col style="width:120px;">
                            <col style="width:120px;">
                            <col style="width:120px;">
                            <col style="width:120px;">
                            <col style="width:120px;">
                            <col style="width:120px;">
                            <col style="width:120px;">
                        </colgroup>
                        <thead>
                        <tr>
                            <th><span>분류</span></th>
                            <th><span>인증서</span></th>
                            <th><span>인증일</span></th>
                            <th><span>만료일</span></th>
                            <th><span>등록일</span></th>
                            <th><span>등록서류</span></th>
                            <th><span>등록</span></th>
                            <th><span>상태</span></th>
                            <th><span>상태일자</span></th>
                        </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </fieldset>
            </form>
            <div id="pagination" class="pagination" style="text-align: center"></div>
        </div>
    </div>
</div>

<div class="cui_dialog" style="width:400px;display:none;" id="IsoAuth">
    <div class="dialog_container">
        <div class="dialog_head">
            <div class="dialog_title">
                <div class="main_label"><span id="modalTitle">신규추가</span></div>
            </div>
            <div class="dialog_toolbar">
                <button class="cui_button icon endpoint modal-close" data-cui-icon="xmark" onClick="modal_close('IsoAuth')"><span>Close</span></button>
            </div>
        </div>
        <div class="dialog_body">
            <div class="body_root">
                <form class="cui_form_field" data-legend="true" name="formIsoAuth">
                    <fieldset>
                        <label class="cui_items_wrap" data-direction="left">
                            <strong class="item_label">분류</strong>
                            <div class="item_content">
                                <select class="cui_select_field wide" id="modalIsoType" name="ISO_TYPE">
                                    <option value="ISO-9001">ISO-9001</option>
                                    <option value="IATF16949">IATF16949</option>
                                    <option value="ISO14001">ISO14001</option>
                                    <option value="ISO45001">ISO45001</option>
                                    <option value="ISO50001">ISO50001</option>
                                    <option value="HSPM">HSPM</option>
                                </select>
                            </div>
                        </label>
                        <label class="cui_items_wrap" data-direction="left">
                            <strong class="item_label">업체명</strong>
                            <div class="item_content">
                                <input id="modalCompanyName" name="COM_NAME" class="cui_text_field fixdata">
                            </div>
                        </label>
                        <label class="cui_items_wrap" data-direction="left">
                            <strong class="item_label">사업본부</strong>
                            <div class="item_content">
                                <select class="cui_select_field wide" id="modalFactoryId" name="FACTORY_ID">
                                    <option value="ISO09001">케미컬(신흥)</option>
                                    <option value="IATF16949">케미컬(평택)</option>
                                </select>
                            </div>
                        </label>
                        <label class="cui_items_wrap" data-direction="left">
                            <strong class="item_label">인증일</strong>
                            <div class="item_content" data-role="calendar-picker">
                                <input type="text" class="cui_text_field" value="2024.09.30" id="modalAuthDate" name="AUTH_DATE">
                                <button type="button" class="cui_button icon endpoint" data-cui-icon="calendar"><span>날자 선택</span></button>
                            </div>
                        </label>
                        <label class="cui_items_wrap" data-direction="left">
                            <strong class="item_label">만료일</strong>
                            <div class="item_content" data-role="calendar-picker">
                                <input type="text" class="cui_text_field" value="2024.09.30" id="modalExpDate" name="EXP_DATE">
                                <button type="button" class="cui_button icon endpoint" data-cui-icon="calendar" id="calendar-icon"><span>날자 선택</span></button>
                            </div>
                        </label>
                        <label class="cui_items_wrap" data-direction="left">
                            <strong class="item_label">첨부</strong>
                            <div class="item_content">
                                <div class="cui_attachments">
                                    <input type="file" class="cui_file_field">
                                    <div class="cui_items_wrap" data-direction="left">
                                        <div class="item_label" data-cui-icon="paperclip"><span>파일명.html</span></div>
                                        <div class="item_content">
                                            <button type="button" class="cui_button icon endpoint" data-cui-icon="download" data-tooltip-title="다운로드"><span>다운로드</span></button>
                                            <button type="button" class="cui_button icon endpoint" data-cui-icon="search_square" data-tooltip-title="미리보기"><span>미리보기</span></button>
                                            <button type="button" class="cui_button icon endpoint" data-cui-icon="xmark" data-tooltip-title="삭제"><span>삭제</span></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </label>
                        <div class="cui_items_wrap" data-direction="center" style="top-margin:10px;">
                            <div class="item_content">
                                <button type="submit" id="IsoAuthAdd" class="cui_button primary"><span>저장</span></button>
                                <button type="button" id="IsoAuthPop" class="cui_button secondary" onClick="modal_close('IsoAuth')"><span>닫기</span></button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function() {

         $.ajax({
            url: '/api/isoAuthItemList/pageMaker',  // 서버에서 pageMaker 객체를 가져오는 API URL
            type: 'GET',
            data: {
                pageNum: 1,  // 기본값으로 첫 페이지를 설정, 필요에 따라 변경
                amount: 10    // 페이지당 항목 수
            },
            success: function(response) {
                // pageMaker 객체를 받아옴
                var startPage = response.startPage;
                var endPage = response.endPage;
                var currentPage = response.criteria.pageNum;
                var totalPages = response.totalPages;

                // 페이지네이션 컨테이너를 업데이트
                var paginationHtml = '';

                // "이전" 버튼 처리
                if (currentPage > 1) {
                    paginationHtml += `<a href="#" class="prev" data-page="${currentPage - 1}">&lt;&lt;</a>`;
                }

                // 페이지 번호 처리
                for (var i = startPage; i <= endPage; i++) {
                    if (i === currentPage) {
                        paginationHtml += `<a href="#" class="page active" data-page="${i}">${i}</a>`;
                    } else {
                        paginationHtml += `<a href="#" class="page" data-page="${i}">${i}</a>`;
                    }
                }

                // "다음" 버튼 처리
                if (currentPage < totalPages) {
                    paginationHtml += `<a href="#" class="next" data-page="${currentPage + 1}">&gt;&gt;</a>`;
                }

                // 페이지네이션 컨테이너에 HTML 추가
                $('#pagination').html(paginationHtml);
                loadPage(1);

                // 페이지 번호 클릭 시 페이지네이션 갱신
                $('.page, .prev, .next').on('click', function(event) {
                    event.preventDefault();
                    var pageNum = $(this).data('page');
                    loadPage(pageNum);
                    // 기존 active 클래스 제거
                    $('.page').removeClass('active');
                    // 새로운 active 페이지에 클래스 추가
                    $(`.page[data-page=${pageNum}]`).addClass('active');
                });
            },
            error: function() {
                alert("페이지네이션 데이터를 가져오는 데 실패했습니다.");
            }
        });

        // 페이지 로드 함수
        function loadPage(pageNum) {
           // 페이지가 로드되면 서버에서 데이터를 가져옴
            $.ajax({
                url: '/api/isoAuthItemList',  // 서버의 API URL
                type: 'GET',
                data: { pageNum: pageNum, amount: 10 },
                success: function(response) {
                    var tableBody = $('#isoAuthItemTable tbody');
                    tableBody.empty(); // 기존 내용 비우기

                    response.forEach(function(isoAuth) {
                        var authDate = new Date(isoAuth.AUTH_DATE); // AUTH_DATE Date 객체로 변환
                        var formattedAuthDate = authDate.toLocaleDateString('ko-KR');  // 날짜를 "YYYY-MM-DD" 형식으로 >> 'ko-KR'을 사용하여 한국 형식으로 표시
                        var expDate = new Date(isoAuth.EXP_DATE); // EXP_DATE를 Date 객체로 변환
                        var formattedExpDate = expDate.toLocaleDateString('ko-KR');  // 날짜를 "YYYY-MM-DD" 형식으로 >> 'ko-KR'을 사용하여 한국 형식으로 표시
                        var regDate = new Date(isoAuth.REG_DATE); // REG_DATE Date 객체로 변환
                        var formattedRegDate = regDate.toLocaleDateString('ko-KR');  // 날짜를 "YYYY-MM-DD" 형식으로 >> 'ko-KR'을 사용하여 한국 형식으로 표시
                        var regDate = new Date(isoAuth.REG_DATE); // REG_DATE Date 객체로 변환
                        var formattedRegDate = regDate.toLocaleDateString('ko-KR');  // 날짜를 "YYYY-MM-DD" 형식으로 >> 'ko-KR'을 사용하여 한국 형식으로 표시
                        var row = '<tr>' +
                                        '<td>' + isoAuth.AUTH_TYPE + '</td>' +
                                        '<td><a href="javascript:void(0);" onclick="modal_open(\'IsoAuth\', \'detail\', \'/api/getIsoAuthData\', \''+ isoAuth.AUTH_CODE + '|'+ isoAuth.COM_CODE + '\')">' +  isoAuth.AUTH_CODE + '</a></td>' +
                                        '<td>' + formattedAuthDate + '</td>' +
                                        '<td>' + formattedExpDate + '</td>' +
                                        '<td>' + formattedRegDate + '</td>' +
                                        '<td>보기</td>' +
                                        '<td>첨부</td>' +
                                        '<td><button type="button" class="cui_button first"><span>승인</span></button><button type="button" class="cui_button secondary"><span>반려</span></button></td>' +
                                        '<td>' + isoAuth.ITEM_STATE + '</td>' +
                                      '</tr>';
                        tableBody.append(row);
                    });
                },
                error: function() {
                    alert("회사를 가져오는 데 실패했습니다.");
                }
            });  // $.ajax 호출 끝
        }

          //인증서 추가
        $("form[name='formIsoAuth']").on('submit', function(e) {
            e.preventDefault(); // 폼의 기본 제출 이벤트를 막음

            $.ajax({
                type: 'POST',
                url: '/api/setIsoAuthData',
                contentType: 'application/json',
                data: { pageNum: pageNum, amount: 10 },
                success: function(response) {
                    console.log('Form successfully submitted!', response);
                    // 성공적으로 제출 후
                    modal_close('IsoAuth'); //모달 닫기
                   //리스트 새로 로드
                },
                error: function(xhr, status, error) {
                    console.error('Form submission failed:', error);
                }
            });
        });

         // datepicker를 input 필드에 적용
        $('#modalExpDate').datepicker({
            dateFormat: 'yy.mm.dd',  // 날짜 포맷을 'YYYY.MM.DD'로 설정
            showOn: "focus",
        });

        // 버튼 클릭 시 input 필드의 datepicker 열기
        $('#calendar-icon').on('click', function() {
            var inputField = $('#modalExpDate');

            // datepicker가 보이면 숨기고, 숨겨져 있으면 보이도록 토글
            if (inputField.datepicker("widget").is(":visible")) {
                inputField.datepicker("hide"); // datepicker 숨기기
            } else {
                inputField.datepicker("show"); // datepicker 보이기
            }
        });

    });

    //상세 항목 정보 - Ajax로 받아온 데이터 바인딩
    function bindModalData(status, data) {
        $('#modalTitle').text(status == 'detail'?'업체 수정':'신규 추가'); //모달창의 제목 변경
        $('#modalIsoType').val(data.AUTH_TYPE);
        $('#modalCompanyName').val(data.COM_CODE);
        $('#modalFactoryId').val(data.AUTH_CODE);
    }

</script>
</body>
</html>