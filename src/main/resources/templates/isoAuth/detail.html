<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://ultraq.net.nz/thymeleaf/layout">
<body>
<div class="cui_content">
    <div class="cui_main">
        <div class="cui_head">
            <div class="head_content">
                <h2 class="cui_title"><span th:text="${companyAuth.COM_NAME}">ISO 인증</span></h2>
            </div>
        </div>
        <div class="cui_body">
            <div class="cui_toolbar">
                <div class="toolbar_content">
                    <div class="toolbar_default"></div>
                </div>
            </div>
            <form class="cui_form_section" data-legend="true">
                <fieldset>
                    <legend><span>인증서 관리(배점 4점)</span></legend>
                    <table class="cui_table center" id="isoAuthItemTable">
                        <colgroup>
                            <col style="width:120px;">
                            <col>
                            <col style="width:120px;">
                            <col style="width:120px;">
                            <col style="width:120px;">
                            <col style="width:120px;">
                            <col style="width:180px;">
                            <col style="width:120px;">
                        </colgroup>
                        <thead>
                        <tr>
                            <th><span>분류</span></th>
                            <th><span>인증서</span></th>
                            <th><span>인증일</span></th>
                            <th><span>만료일</span></th>
                            <th><span>등록일</span></th>
                            <th><span>등록서류</span></th>
                            <th><span>상태</span></th>
                            <th><span>상태일자</span></th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </fieldset>
                <fieldset id="rejectArea" style="display:none;">
                    <legend><span>반려사유</span></legend>
                    <div>
                        <textarea class="cui_text_field" rows="2" style="width:100%;" id="rejectReason" th:text="${companyAuth.STATE_REASON}"></textarea>
                    </div>
                </fieldset>
                <div class="cui_items_wrap" data-direction="right">
                    <div class="item_content">
                        <button type="button" class="cui_button primary" id="approveIsoAuth"><span>승인</span></button>
                        <button type="button" class="cui_button primary" id="rejectIsoAuth"><span>반려</span></button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="cui_dialog" style="width:400px;display:none;" id="Reason">
    <div class="dialog_container">
        <div class="dialog_head">
            <div class="dialog_title">
                <div class="main_label"><span>반려 사유</span></div>
            </div>
            <div class="dialog_toolbar">
                <button class="cui_button icon endpoint modal-close" data-cui-icon="xmark" onClick="modal_close('Reason')"><span>Close</span></button>
            </div>
        </div>
        <div class="dialog_body">
            <div class="body_root">
                <form class="cui_form_field" data-legend="true" id="formReason">
                    <div>
                        <textarea class="cui_text_field" rows="2" style="width:100%;" id="inputReason"></textarea>
                    </div>
                    <div class="cui_items_wrap" data-direction="center" style="top-margin:20px;">
                        <div class="item_content">
                            <button type="submit" id="ReasonAdd" class="cui_button primary"><span>저장</span></button>
                            <button type="button" id="ReasonPop" class="cui_button secondary" onClick="modal_close('Reason')"><span>닫기</span></button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function() {
        loadPage(1);
        // 페이지 로드 함수
        function loadPage(pageNum) {
            const code = `[[${companyAuth.COM_CODE}]]`;
           // 페이지가 로드되면 서버에서 데이터를 가져옴
            $.ajax({
                url: '/api/isoAuthItemList',  // 서버의 API URL
                type: 'GET',
                data: { pageNum: pageNum, amount: 10, COM_CODE: code },
                success: function(response) {
                    var tableBody = $('#isoAuthItemTable tbody');
                    tableBody.empty(); // 기존 내용 비우기

                    // AUTH_CODE 매핑 객체 선언
                    var authCodeMap = {
                        'ISO9001': '품질관리',
                        'IATF16949': '품질관리',
                        'ISO14001': '환경',
                        'ISO45001': '안전보건',
                        'KOSHA MS': '안전보건',
                        'QC080000': 'HSPM',
                        'ISO50001': 'ENERGY',
                        '녹색기업': '기타'
                    };
                     if (!response || response.length === 0) {
                        var row = '<tr><td colspan="8">데이터가 없습니다.</td>></tr>';
                        tableBody.append(row);  // 테이블에 새 행 추가
                     }else{
                        response.forEach(function(isoAuth) {
                            var row = '<tr>' +
                                            '<td>' + isoAuth.AUTH_TYPE  + '</td>' +
                                            '<td>' + isoAuth.AUTH_CODE + '</td>' +
                                            '<td>' + isoAuth.AUTH_DATE + '</td>' +
                                            '<td>' + isoAuth.EXP_DATE + '</td>' +
                                            '<td>' + isoAuth.REG_DATE + '</td>' +
                                            '<td><a href="/api/getIsoAuthFileDown?filename=' + encodeURIComponent(isoAuth.FILE_NAME) + '" download>다운로드</a></td>' +
                                            '<td><button type="button" class="cui_button first"><span>승인</span></button><button type="button" class="cui_button secondary"><span>반려</span></button></td>' +
                                            '<td>' + isoAuth.UP_DATE + '</td>' +
                                          '</tr>';
                            tableBody.append(row);
                        });
                        }
                },
                error: function() {
                    showAlert('warning','정보를 가져오는 데 실패했습니다.');
                }
            });  // $.ajax 호출 끝
        }


    });

    //상세 항목 정보 - Ajax로 받아온 데이터 바인딩
    function bindModalData(status, data) {
        $('#modalTitle').text(status == 'detail'?'업체 수정':'신규 추가'); //모달창의 제목 변경
            const authTypeSelect = document.getElementById("modalAuthType");
            const authSelect = document.getElementById("modalAuthCode");
            authTypeSelect.value = data.AUTH_TYPE;
            authSelect.value = data.AUTH_CODE;
            $('#modalCompanyName').val(data.COM_CODE);
            $('#modalAuthDate').val(data.AUTH_DATE);
            $('#modalExpDate').val(data.EXP_DATE);
            $('#attachInfo').css('display', 'block');
            $('#modalFileName span').text(data.FILE_NAME);
    }

    // 반려 버튼 클릭시 반려사유 입력
    $('#rejectIsoAuth').on('click', function() {
        modal_open('Reason', 'add', '', '') //모달창 오픈
    });

    // 반려 사유 저장
    $('#ReasonAdd').on('click', function() {
        const code = `[[${companyAuth.COM_CODE}]]`;
        const inputReason = $('#inputReason').val();  // 반려사유
        const state = 'REJECT';
        $.ajax({
            url: '/api/setIsoAuthData',  // 서버의 API URL
            type: 'GET',
            data: { reason: inputReason, state: state, com_code: code },
            success: function(response) {
                showAlert('success','데이터가 성공적으로 저장되었습니다.');
                //리스트 새로 로드 - 상태가 바뀌므로
                loadPage(1);
            },
            error: function() {
                showAlert('warning','정보를 가져오는 데 실패했습니다.');
            }
        });  // $.ajax 호출 끝
    });

     // 반려 버튼 클릭시 반려사유 입력
    $('#approveIsoAuth').on('click', function() {
        const code = `[[${companyAuth.COM_CODE}]]`;
        const state = 'APPROVE';
        $.ajax({
            url: '/api/setIsoAuthData',  // 서버의 API URL
            type: 'GET',
            data: { reason: inputReason, state: state, com_code: code },
            success: function(response) {
                showAlert('success','데이터가 성공적으로 저장되었습니다.');
                //리스트 새로 로드 - 상태가 바뀌므로
                loadPage(1);
            },
            error: function() {
                showAlert('warning','정보를 가져오는 데 실패했습니다.');
            }
        });  // $.ajax 호출 끝
    });
</script>
</body>
</html>