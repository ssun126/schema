<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/defaultLayout}"
      layout:fragment="Content">
<body>
        <div class="cui_content">
            <div class="cui_main">
                <div class="cui_head">
                    <div class="head_content">
                        <h2 class="cui_title"><span>Company Information</span></h2>
                    </div>
                </div>
                <div class="cui_body">
                    <form id="updateForm" method="POST" action="/companyInfo/mainUpdate"  class="cui_form_section">
                        <fieldset>
                            <legend><span>업체 기본정보</span></legend>
                            <table class="cui_table">
                                <colgroup>
                                    <col style="width:154px;">
                                    <col>
                                    <col style="width:154px;">
                                    <col>
                                </colgroup>
                                <tbody>
                                <tr>
                                    <th><span>Vendor 번호</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${member.COM_CODE}" ></span>
                                                <input type="hidden" name="COM_CODE" id="COM_CODE" th:value="${member.COM_CODE}" >
                                            </div>
                                        </div>
                                    </td>
                                    <th><span>귀사 정보</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${member.COM_NAME}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th><span>Vendor 업종 형태</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <label class="cui_checkbox">
                                                    <input type="radio" name="VENDOR_WORK_KIND" value="D" id="Manufacturer"
                                                           th:checked="${member.VENDOR_WORK_KIND == 'D'}" disabled>
                                                    <i></i><span>제조사</span>
                                                </label>

                                                <label class="cui_checkbox">
                                                    <input type="radio" name="VENDOR_WORK_KIND" value="L" id="Logistics"
                                                           th:checked="${member.VENDOR_WORK_KIND == 'L'}" disabled>
                                                    <i></i><span>물류사</span>
                                                </label>

                                            </div>
                                        </div>
                                    </td>
                                    <th><span>국가</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${member.COM_NATION}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th><span>회사명</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${member.COMPANY_NAME}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                    <th><span>제조 공장명</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${member.FACTORY_NAME}"></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th><span>사업자 등록번호</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span  th:text="${member.BUS_NUMBER}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                    <th><span>회사주소 (영문)</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${member.COM_ADDRESS}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th><span>CEO 성명(영문)</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span  th:text="${member.COM_CEO_NAME}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                    <th><span>CEO 연락처(영문)</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${member.COM_CEO_PHONE}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th><span>CEO e-mail(영문)</span></th>
                                    <td colspan="3">
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${member.COM_CEO_EMAIL}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                </tbody>
                            </table>
                        </fieldset>

                    </form>
                    <form class="cui_form_section" data-legend="true">
                        <fieldset>
                            <legend><span>DWFC 거래 사업부</span></legend>
                            <table class="cui_table">
                                <colgroup>
                                    <col style="width:154px;">
                                    <col>
                                </colgroup>
                                <tbody>
                                <tr>
                                    <th><span>사업본부</span></th>
                                    <td>
                                        <div th:each="companyCodeWork, iterStat : ${companyCodeWorkList}">
                                            <span th:text="${iterStat.index + 1} + ') ' + ${companyCodeWork.BASE_NAME}"></span><br>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </fieldset>

                        <fieldset>
                            <legend><span>공동 업무자 정보</span></legend>
                            <table class="cui_table center">
                                <thead>
                                <tr>
                                    <th><span>담당자 구분</span></th>
                                    <th><span>성명(영문)</span></th>
                                    <th><span>직위</span></th>
                                    <th><span>부서명</span></th>
                                    <th><span>email</span></th>
                                    <th><span>연락처</span></th>
                                    <th>
                                    </th>
                                </tr>
                                </thead>
                                <tbody id="tableBody">
                                <tr class="collaborator-row" th:each=" user : ${companyUserList}">
                                    <td><span th:text="${user.MAIN_USER_YN == 'Y' ? '메인 담당자' : '공동 업무자'}"></span>
                                        <input type="hidden"  name="MAIN_USER_YN"  class="cui_text_field" th:value="${user.MAIN_USER_YN}">
                                        <input type="hidden"  name="MAIN_USER_IDX"  class="cui_text_field" th:value="${user.USER_IDX}">

                                    </td>

                                    <td>
                                        <span th:text="${user.USER_NAME}"></span>
                                        <input type="hidden"  name="COM_USER_IDX"  class="cui_text_field" th:value="${user.COM_USER_IDX}">
                                    </td>
                                    <td><span  th:text="${user.USER_POSITION}"></span></td>
                                    <td><span th:text="${user.USER_DEPT}"></span></td>
                                    <td><span  th:text="${user.USER_EMAIL}"></span></td>
                                    <td><span  th:text="${user.USER_PHONE}"></span></td>
                                    <td></td>
                                </tr>
                                </tbody>
                            </table>
                        </fieldset>
                    </form>
                    <form class="cui_form_section" data-legend="true">
                        <fieldset>
                            <legend><span>Warranty 협약 상태</span></legend>
                            <table class="cui_table center">
                                <colgroup>
                                    <col>
                                    <col>
                                    <col style="width:250px;">
                                    <col>
                                </colgroup>
                                <tbody>
                                <tr>
                                    <th><span>승인일</span></th>
                                    <th><span>제출일</span></th>
                                    <th><span>관리상태</span></th>
                                    <th><span>양식 첨부</span></th>
                                </tr>
                                <tr>
                                    <td>
                                        <span th:text="${member.COM_OK_DATE}"></span>
                                    </td>
                                    <td>
                                        <span th:text="${member.COM_APP_DATE}"></span>

                                    </td>
                                    <td>
                                        <span th:switch="${member.COM_MANAGE_STATUS}">
                                            <span th:case="'0'">Pending</span>
                                            <span th:case="'1'">Waiting</span>
                                            <span th:case="'2'">Approved</span>
                                            <span th:case="'3'">Rejected</span>
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" class="cui_button"  onclick ="downloadFile()"><span>보기</span></button>
                                        <input type="hidden" name ="COM_FILE_NAME" id="COM_FILE_NAME"  th:value="${member.COM_FILE_NAME}" >
                                    </td>
                                </tr>

                                </tbody>
                            </table>
                        </fieldset>
                    </form>
                    <form class="cui_form_section" data-legend="true">
                        <fieldset>
                            <legend><span>신청 정보</span></legend>
                            <table class="cui_table">
                                <colgroup>
                                    <col style="width:200px;">
                                    <col>
                                    <col style="width:200px;">
                                    <col>
                                </colgroup>
                                <tbody>
                                <tbody>
                                <tr>
                                    <th><span>신청구분</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${companyApprovalID.ID_ADD_TYPE == '0' ? '신규' : 'ID추가'}"></span>
                                                <input type="hidden" name="ID_ADD_TYPE" id="ID_ADD_TYPE" th:value="${companyApprovalID.ID_ADD_TYPE}">
                                            </div>
                                        </div>
                                    </td>
                                    <th><span>신청일</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${companyApprovalID.REG_DATE}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                <tr>
                                    <th><span>ID</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${companyApprovalID.USER_ID}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                    <th><span>이름</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${companyApprovalID.USER_NAME}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                <tr>
                                    <th><span>처리상태</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${companyApprovalID.USER_STATUS}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                    <th><span>처리일</span></th>
                                    <td>
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${companyApprovalID.USER_OK_DATE}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:if="${companyApprovalID.USER_STATUS == '반려'}">
                                    <th><span>반려사유</span></th>
                                    <td colspan="3">
                                        <div class="cui_items_wrap" data-direction="left">
                                            <div class="item_content">
                                                <span th:text="${companyApprovalID.RETURN_REASON}" ></span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                </tbody>

                            </table>
                        </fieldset>
                        <div class="cui_items_wrap" data-direction="right">
                            <div class="item_content">
                                <button type="button" class="cui_button primary" th:onClick="'approval(' + ${companyApprovalID.USER_IDX} + ')'"><span>승인</span></button>
                                <button type="button" class="cui_button primary" onclick="modal('dialogUserUpdate')"><span>반려</span></button>
                                <button type="button" class="cui_button secondary" onClick="goList()">
                                    <span th:text="${prepage != '' ? '뒤로' : '목록'}"></span>
                                </button>
                                <input type="hidden" name="prePage" id="prePage" th:value="${prepage}">
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
</body>


<div class="cui_dialog" style="width:720px;display:none;" id="dialogUserUpdate">
    <div class="dialog_container">
        <div class="dialog_head">
            <div class="dialog_title">
                <div class="main_label"><span id="popTitle">반려</span></div>
            </div>
            <div class="dialog_toolbar">
                <button class="cui_button icon endpoint modal-close" data-cui-icon="xmark"><span>Close</span></button>
            </div>
        </div>

        <div class="dialog_body">
            <div class="body_root">
                <form id="updateForm1" method="POST" action="/userMgr/updateUserMgr" class="cui_form_section" data-legend="true">
                    <fieldset>

                        <label class="cui_items_wrap" data-direction="left">
                            <strong class="item_label">반려사유</strong>
                            <div class="item_content">
                                <textarea  style="height:80px;" class="cui_text_field" id="RETURN_REASON" name="RETURN_REASON"></textarea>
                            </div>
                        </label>

                        <div class="cui_items_wrap" data-direction="center">
                            <div class="item_content">
                                <button type="button" class="cui_button primary" th:onClick="'reject(' + ${companyApprovalID.USER_IDX} + ')'"><span>반려 처리</span></button>
                                <button type="button" class="cui_button secondary" onClick="modalReject_close_('dialogUserUpdate')"><span>닫기</span></button>
                            </div>
                        </div>
                    </fieldset>
                </form>

            </div>
        </div>
    </div>
</div>

</html>

<script id ='detailscript'>

    function approval(userIdx) {
        showConfirm('warning', '승인하시겠습니까?', function(isConfirmed) {
            if (isConfirmed) {
              updateCpUser(userIdx,"Y");
            } else {
                //alert('아니오');
            }
        });
    }

    function reject(userIdx) {
        updateCpUser(userIdx,"N") ;
    }


   function updateCpUser(userIdx , ApprovalType) {

         let comCode = document.getElementById('COM_CODE').value ;
         let returnReason = document.getElementById('RETURN_REASON').value ;
         let idAddType = document.getElementById('ID_ADD_TYPE').value ;

         $.ajax({
            type: "post",
            url: "/user/companyInfo/approvalCompanyUser",
            data: {
                  "USER_IDX": userIdx ,
                  "ApprovalType" : ApprovalType ,
                  "RETURN_REASON" : returnReason ,
                  "COME_CODE" : comCode ,
                  "ID_ADD_TYPE" : idAddType ,
              },
            success: function(response) {
                if(response.status === "success") {
                    showAlert('success', response.message);
                }
            },
            error: function(err) {
              console.log("에러발생", err);
              showAlert('warning',err);
            }
        });
   }


   //모달 열기
    function modal(id){
      $("#" + id).fadeIn()
    }

    //닫기
    function modal_close(id){
        $("#" + id).fadeOut();
        goList();
    }

    //반려 닫기
    function modalReject_close_(id){
        $("#" + id).fadeOut();
    }

    function goList() {

        let prePage = document.getElementById('prePage').value ;
        let comCode = document.getElementById('COM_CODE').value ;
        if(!prePage){
            let url = "/admin/companyInfo/cpApproval";
            renderContent(url,true);
        }else{
            let url = "/admin/companyInfo/cpMainListDetail?com_code="+comCode;
            location.href = url;
        }
    }

   //warranty 파일 다운로드
   function downloadFile() {

       const hiddenInput = document.getElementById('COM_FILE_NAME');
       var fileName = hiddenInput.value;
       let comCode = document.getElementById('COM_CODE').value ;

       if(fileName == ""){
           //alert('첨부된 파일이 없습니다.') ;
           showAlert('warning', '첨부된 파일이 없습니다.');
           return;
       }

       fetch(`/member/warrantyDownLoad?fileName=${encodeURIComponent(fileName)}`+'&comCode='+comCode, {
           method: 'GET',
           headers: {
               'Accept': 'application/octet-stream'
           }
       })
       .then(response => {
           if (!response.ok) {
               throw new Error('Network response was not ok');
           }
           return response.blob();
       })
       .then(blob => {
           // Blob URL 생성
           const url = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = fileName;
           document.body.appendChild(a);
           a.click();
           a.remove();
           window.URL.revokeObjectURL(url);
       })
       .catch(error => {
           console.error('파일 다운로드 실패:', error);
       });
   }


</script>