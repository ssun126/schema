<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="IsoAuthItem">
    <insert id="saveItem" parameterType="isoAuthItem">
        INSERT INTO ISO_AUTH_COMPANY_ITEM(COM_CODE, AUTH_TYPE, AUTH_CODE, AUTH_DATE, EXP_DATE, REG_DW_USER_IDX, UP_DW_USER_IDX, REG_DATE, UP_DATE, ITEM_STATE, FILE_NAME, FILE_PATH)
        VALUES (#{COM_CODE}, #{AUTH_TYPE}, #{AUTH_CODE}, #{AUTH_DATE}, #{EXP_DATE}, #{REG_DW_USER_IDX}, #{UP_DW_USER_IDX}, sysdate, sysdate, 'SEND', #{FILE_NAME}, #{FILE_PATH})
    </insert>

    <insert id="saveAuth" parameterType="isoAuth">
        INSERT INTO AUTH_COMPANY_INFO(COM_CODE, APPROVE_STATE, SEND_DATE, AUTH_TYPE, REG_DW_USER_IDX, UP_DW_USER_IDX, REG_DATE, UP_DATE)
        VALUES (#{COM_CODE}, #{APPROVE_STATE}, sysdate, #{AUTH_TYPE}, #{REG_DW_USER_IDX}, #{UP_DW_USER_IDX}, sysdate, sysdate)
    </insert>

    <insert id="saveAuthResult" parameterType="isoAuth">
        UPDATE AUTH_COMPANY_INFO
            SET APPROVE_STATE = #{APPROVE_STATE}, APPROVE_DATE= #{APPROVE_DATE}, POINT = #{POINT}, STATE_REASON = #{STATE_REASON}, UP_DW_USER_IDX = #{UP_DW_USER_IDX}, UP_DATE = sysdate
        WHERE COM_CODE = #{COM_CODE}
        AND AUTH_TYPE = #{AUTH_TYPE}
    </insert>

    <select id="findByIsoAuthItem" parameterType="map" resultType="isoAuthItem">
        select * from ISO_AUTH_COMPANY_ITEM where AUTH_CODE=#{AUTH_CODE} and COM_CODE=#{COM_CODE}
    </select>

    <select id="getCompanyAuth" parameterType="map" resultType="isoAuth">
        SELECT ACI.COM_CODE, CC.COM_NAME, AUTH_TYPE, APPROVE_STATE, APPROVE_DATE, SEND_DATE, POINT
        FROM AUTH_COMPANY_INFO ACI
        INNER JOIN COMPANY_CODE CC
        ON CC.COM_CODE = ACI.COM_CODE
        WHERE AUTH_TYPE=#{AUTH_TYPE} and ACI.COM_CODE=#{COM_CODE}
    </select>

    <select id="searchCompanies" parameterType="map" resultType="isoAuth">
        SELECT RN, COM_CODE, COM_NAME, AUTH_TYPE, APPROVE_STATE, TO_CHAR(APPROVE_DATE, 'YYYY.MM.DD') AS APPROVE_DATE, TO_CHAR(SEND_DATE, 'YYYY.MM.DD') AS SEND_DATE, POINT
        FROM
        (
            SELECT /*+ INDEX_DESC(ISO_AUTH_COMPANY_ITEM PK_ISO_AUTH_COMPANY_ITEM) */
                ROWNUM RN, ACI.COM_CODE, CC.COM_NAME, AUTH_TYPE, APPROVE_STATE, APPROVE_DATE, SEND_DATE, POINT
            FROM AUTH_COMPANY_INFO ACI
            INNER JOIN COMPANY_CODE CC
            ON CC.COM_CODE = ACI.COM_CODE
            WHERE 1 =1
            <if test="COM_CODE != null and COM_CODE != ''">
                AND (ACI.COM_CODE LIKE CONCAT(CONCAT('%',  #{COM_CODE}), '%'))
            </if>
            <if test="COM_NAME != null and COM_NAME != ''">
                AND (CC.COM_NAME LIKE CONCAT(CONCAT('%',  #{COM_NAME}), '%'))
            </if>
            <if test="COM_STATUS != null and COM_STATUS != ''">
                AND (ACI.APPROVE_STATE LIKE CONCAT(CONCAT('%',  #{COM_STATUS}), '%'))
            </if>
            <if test="AUTH_TYPE != null and AUTH_TYPE != ''">
                AND (ACI.AUTH_TYPE LIKE CONCAT(CONCAT('%',  #{AUTH_TYPE}), '%'))
            </if>
            <if test="criteria != null and criteria != ''">
        <![CDATA[  AND ROWNUM <= (#{criteria.pageNum} * #{criteria.amount}) ]]>
            </if>
        )
        WHERE RN > ((#{criteria.pageNum}-1) * #{criteria.amount})
    </select>

    <select id="countByKeyword" parameterType="map" resultType="int">
        select count(*) CNT
        from AUTH_COMPANY_INFO ACI
        INNER JOIN COMPANY_CODE CC
        ON CC.COM_CODE = ACI.COM_CODE
        WHERE 1 =1
        <if test="COM_CODE != null and COM_CODE != ''">
            AND (ACI.COM_CODE LIKE CONCAT(CONCAT('%',  #{COM_CODE}), '%'))
        </if>
        <if test="COM_NAME != null and COM_NAME != ''">
            AND (CC.COM_NAME LIKE CONCAT(CONCAT('%',  #{COM_NAME}), '%'))
        </if>
        <if test="COM_STATUS != null and COM_STATUS != ''">
            AND (ACI.APPROVE_STATE LIKE CONCAT(CONCAT('%',  #{COM_STATUS}), '%'))
        </if>
        <if test="AUTH_TYPE != null and AUTH_TYPE != ''">
            AND (ACI.AUTH_TYPE LIKE CONCAT(CONCAT('%',  #{AUTH_TYPE}), '%'))
        </if>
    </select>

    <select id="getList" parameterType="map" resultType="isoAuthItem">
        <![CDATA[
        SELECT RN, COM_CODE, AUTH_TYPE, AUTH_CODE, TO_CHAR(AUTH_DATE, 'YYYY.MM.DD') AS AUTH_DATE, TO_CHAR(EXP_DATE, 'YYYY.MM.DD') AS EXP_DATE,
            TO_CHAR(REG_DATE, 'YYYY.MM.DD') AS REG_DATE, TO_CHAR(UP_DATE, 'YYYY.MM.DD') AS UP_DATE, ITEM_STATE, FILE_NAME, FILE_PATH
        FROM
        (
            SELECT /*+ INDEX_DESC(ISO_AUTH_COMPANY_ITEM PK_ISO_AUTH_COMPANY_ITEM) */
            ROWNUM RN, COM_CODE, AUTH_TYPE, AUTH_CODE, AUTH_DATE, EXP_DATE, REG_DATE, UP_DATE, ITEM_STATE, FILE_NAME, FILE_PATH
            FROM ISO_AUTH_COMPANY_ITEM
            WHERE COM_CODE = #{COM_CODE}
        )
        ]]>
    </select>

    <select id="getTotal" resultType="int">
        select count(*) CNT
        from ISO_AUTH_COMPANY_ITEM
    </select>

    <select id="getExpDateList" parameterType="map" resultType="isoAuthItem">
        SELECT RN, COM_CODE, COM_NAME, AUTH_TYPE, AUTH_CODE, AUTH_DATE, EXP_DATE, REG_DATE, UP_DATE, ITEM_STATE, FILE_NAME, FILE_PATH
        FROM
        (
        SELECT /*+ INDEX_DESC(ISO_AUTH_COMPANY_ITEM PK_ISO_AUTH_COMPANY_ITEM) */
            ROWNUM RN, ACI.COM_CODE, CC.COM_NAME, AUTH_TYPE, AUTH_CODE, TO_CHAR(AUTH_DATE, 'YYYY.MM.DD') AS AUTH_DATE,
            TO_CHAR(EXP_DATE, 'YYYY.MM.DD') AS EXP_DATE, TO_CHAR(ACI.REG_DATE, 'YYYY.MM.DD') AS REG_DATE, TO_CHAR(ACI.UP_DATE, 'YYYY.MM.DD') AS UP_DATE,
            ITEM_STATE, FILE_NAME, FILE_PATH
        FROM ISO_AUTH_COMPANY_ITEM ACI
        INNER JOIN COMPANY_CODE CC
        ON CC.COM_CODE = ACI.COM_CODE
        WHERE 1 =1
        <if test="COM_CODE != null and COM_CODE != ''">
            AND (ACI.COM_CODE LIKE CONCAT(CONCAT('%',  #{COM_CODE}), '%'))
        </if>
        <if test="COM_NAME != null and COM_NAME != ''">
            AND (CC.COM_NAME LIKE CONCAT(CONCAT('%',  #{COM_NAME}), '%'))
        </if>
        <if test="EXP_DATE != null and EXP_DATE != ''">
            AND TO_CHAR(ACI.EXP_DATE, 'YYYY.MM') = #{EXP_DATE}
        </if>
        <if test="criteria != null and criteria != ''">
            <![CDATA[  AND ROWNUM <= (#{criteria.pageNum} * #{criteria.amount}) ]]>
        </if>
        )
        WHERE RN > ((#{criteria.pageNum}-1) * #{criteria.amount})
    </select>

    <update id="updateStatus" parameterType="isoAuthItem">
        update ISO_AUTH_COMPANY_ITEM set ITEM_STATE=#{ITEM_STATE}
        where COM_CODE=#{COM_CODE}
    </update>
</mapper>